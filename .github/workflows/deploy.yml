name: Deploy Laravel para public_html via FTP (Otimizado e Corrigido)

on:
  push:
    branches:
    - main

jobs:
  test:
    name: Executar Testes
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Obter cÃ³digo mais recente
      uses: actions/checkout@v4

    - name: ğŸ—ƒï¸ Cache Composer
      uses: actions/cache@v3
      with:
        path: vendor
        key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
        restore-keys: |
          ${{ runner.os }}-composer-

    - name: ğŸ“¦ Instalar dependÃªncias do Composer
      run: composer install --prefer-dist --no-interaction --no-scripts

    - name: ğŸ› ï¸ Configurar ambiente
      run: |
        [ -f ".env.testing" ] && cp .env.testing .env || cp .env.example .env
        echo "APP_ENV=testing" >> .env
        echo "APP_DEBUG=true" >> .env
        echo "DB_CONNECTION=sqlite" >> .env
        echo "DB_DATABASE=:memory:" >> .env
        php artisan key:generate

    - name: ğŸ§ª Rodar testes
      run: ./vendor/bin/phpunit

  deploy:
    name: Deploy Laravel via FTP
    runs-on: ubuntu-latest
    needs: test # Depende do job "test"
    timeout-minutes: 10

    steps:
    - name: ğŸ“¥ Obter cÃ³digo
      uses: actions/checkout@v4

    - name: ğŸ—ƒï¸ Cache Composer
      uses: actions/cache@v3
      with:
        path: vendor
        key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
        restore-keys: |
          ${{ runner.os }}-composer-

    - name: ğŸ“¦ Instalar dependÃªncias de produÃ§Ã£o
      run: composer install --no-dev --prefer-dist --optimize-autoloader --no-interaction

    - name: ğŸ—ƒï¸ Cache NPM
      uses: actions/cache@v3
      with:
        path: ~/.npm
        key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-node-

    - name: ğŸ“¦ Instalar dependÃªncias do NPM
      run: |
        if [ -f "package-lock.json" ]; then
          npm ci
        else
          npm install
        fi

    - name: ğŸ”¨ Compilar assets
      run: npm run build

    - name: ğŸ§¹ Limpar arquivos desnecessÃ¡rios
      run: |
        # Remove diretÃ³rios e arquivos que nÃ£o devem ser enviados
        rm -rf node_modules .git tests docs docker examples build .github .idea .vscode
        find . -type f -name "*.md" -delete
        find . -type f -name "*.log" -delete
        find . -type f -name "*.sql" -delete
        find . -type f -name "*.txt" -delete
        find . -type f -name "*.xml" -delete
        find . -type f -name "*.yml" -delete
        find . -type f -name "*.lock" -delete
        find . -type f -name "*.dist" -delete
        find . -type f -name "*.example" -delete
        find . -type f -name "*.sample" -delete

    - name: ğŸ“¤ Upload FTP inteligente
      uses: SamKirkland/FTP-Deploy-Action@4.3.0
      with:
        server: ${{ secrets.FTP_SERVER }}
        username: ${{ secrets.FTP_USER }}
        password: ${{ secrets.FTP_PASSWORD }}
        server-dir: ${{ secrets.HOSTGATOR_DEPLOY_DIR }}
        local-dir: ./
        exclude: |
          **/.git*
          **/node_modules/*
          **/vendor/*
          **/storage/*
          **/bootstrap/cache/*
          **/tests/*
          **/docs/*
          **/docker/*
          **/examples/*
          **/build/*
          **/*.md
          **/*.log
          **/*.sql
          **/*.txt
          **/*.xml
          **/*.yml
          **/*.lock
          **/*.dist
          **/*.example
          **/*.sample

    - name: ğŸš€ ConfiguraÃ§Ã£o Remota
      run: |
        ssh -i <(echo "${{ secrets.SSH_PRIVATE_KEY }}") \
          -o StrictHostKeyChecking=no \
          ${{ secrets.SSH_USER }}@${{ secrets.SERVER }} <<EOF
        cd ${{ secrets.HOSTGATOR_DEPLOY_DIR }}

        # Ambiente
        [ -f .env ] || echo "${{ secrets.ENV_FILE }}" > .env

        # OtimizaÃ§Ãµes
        php artisan config:cache
        php artisan route:cache
        php artisan view:cache

        # PermissÃµes
        chmod -R 775 storage bootstrap/cache
        chown -R www-data:www-data storage bootstrap/cache

        # MigraÃ§Ãµes
        php artisan migrate --force --no-interaction

        echo "ğŸš€ Deploy concluÃ­do com sucesso!"
        EOF
