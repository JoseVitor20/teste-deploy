name: Deploy + Instalação do Laravel na Hostgator

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      # Passo 1: Baixar o código do repositório
      - name: 📥 Obter código
        uses: actions/checkout@v3

      # Passo 2: Enviar arquivos iniciais via FTP (sem vendor/node_modules)
      - name: 🚀 Enviar arquivos essenciais via FTP
        uses: SamKirkland/FTP-Deploy-Action@4.3.0
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USER }}
          password: ${{ secrets.FTP_PASSWORD }}
          server-dir: "public_html/meuapp"
          exclude: |
            **/.env*
            **/vendor/*
            **/node_modules/*
            **/.git/*

      # Passo 3: Instalar o Laravel e dependências via SSH
      - name: 🛠️ Instalar Laravel e configurar ambiente
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SERVER }} << 'EOF'
          cd ~/public_html/meuapp

          # Instalar o Laravel via Composer (se for a primeira vez)
          if [ ! -f "artisan" ]; then
            echo "🔧 Instalando Laravel..."
            composer create-project --prefer-dist laravel/laravel .
          fi

          # Criar/copiar .env (substitua os valores pelos seus secrets)
          echo "🔑 Configurando .env..."
          cat > .env << "ENV_EOF"
          APP_NAME=MeuApp
          APP_ENV=production
          APP_KEY=${{ secrets.APP_KEY }}
          DB_HOST=localhost
          DB_DATABASE=${{ secrets.DB_DATABASE }}
          DB_USERNAME=${{ secrets.DB_USERNAME }}
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          ENV_EOF

          # Instalar dependências e otimizar
          echo "📦 Instalando dependências..."
          composer install --no-dev --optimize-autoloader
          npm install --omit=dev && npm run build

          # Configurar permissões e cache
          echo "⚙️ Ajustando permissões..."
          chmod -R 755 storage bootstrap/cache
          php artisan storage:link
          php artisan optimize

          # Executar migrations (se necessário)
          echo "🗄️ Migrando banco de dados..."
          php artisan migrate --force

          echo "✅ Instalação concluída!"
          EOF
